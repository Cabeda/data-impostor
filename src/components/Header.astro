---
import HeaderLink from "./HeaderLink.astro";
import { SITE_TITLE } from "../consts";
import MastodonIcon from "./icons/MastodonIcon.astro";
import GitHubIcon from "./icons/GitHubIcon.astro";
import RssIcon from "./icons/RssIcon.astro";
---

<header>
  <nav>
    <h2><a href="/">{SITE_TITLE}</a></h2>
    <div class="internal-links">
      <HeaderLink href="/blog">Blog</HeaderLink>
      <HeaderLink href="/mastodon">Mastodon</HeaderLink>
      <HeaderLink href="/projects">Projects</HeaderLink>
      <HeaderLink href="/talks">Talks</HeaderLink>
      <HeaderLink href="/reads">Reads</HeaderLink>
      <HeaderLink href="/about">About</HeaderLink>
    </div>
    <button id="menuToggle" class="menu-button" aria-expanded="false" aria-controls="navPanel" aria-label="Menu">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
    <div id="navPanel" class="nav-panel" aria-hidden="true">
      <div class="nav-panel-inner">
        <div class="panel-header">
          <button id="panelClose" class="panel-close" aria-label="Close menu">Ã—</button>
        </div>
        <nav class="panel-links">
          <HeaderLink href="/blog">Blog</HeaderLink>
          <HeaderLink href="/mastodon">Mastodon</HeaderLink>
          <HeaderLink href="/projects">Projects</HeaderLink>
          <HeaderLink href="/talks">Talks</HeaderLink>
          <HeaderLink href="/reads">Reads</HeaderLink>
          <HeaderLink href="/about">About</HeaderLink>
        </nav>
        <div class="panel-social">
          <a href="https://mastodon.social/@jecabeda" target="_blank" aria-label="Mastodon">
            <MastodonIcon width={36} height={36} />
          </a>
          <a href="https://github.com/cabeda" target="_blank" aria-label="GitHub">
            <GitHubIcon width={36} height={36} />
          </a>
          <a href="https://cabeda.dev/rss.xml" target="_blank" aria-label="RSS">
            <RssIcon width={36} height={36} />
          </a>
        </div>
      </div>
    </div>
    <div class="social-links">
      <a href="https://mastodon.social/@jecabeda" target="_blank">
        <span class="sr-only">Follow me on Mastodon</span>
        <MastodonIcon width={32} height={32} />
      </a>
      <a href="https://github.com/cabeda" target="_blank">
        <span class="sr-only">Go to my GitHub repo</span>
        <GitHubIcon width={32} height={32} />
      </a>
      <a href="https://cabeda.dev/rss.xml" target="_blank">
        <span class="sr-only">Go to my RSS feed</span>
        <RssIcon width={30} height={32} />
      </a>
    </div>
  </nav>
</header>

<style>
  header {
    margin: 0;
    padding: 0 1em;
    background: white;
    box-shadow: 0 2px 8px rgba(var(--black), 5%);
    position: relative;
    z-index: 100;
  }
  h2 {
    margin: 0;
    font-size: 1em;
  }

  h2 a,
  h2 a.active {
    text-decoration: none;
  }
  nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .internal-links {
    display: flex;
    gap: 0.25rem;
    flex: 1 1 auto;
    white-space: nowrap;
    overflow: hidden;
    align-items: center;
  }

  nav a {
    padding: 1em 0.5em;
    color: var(--black);
    border-bottom: 4px solid transparent;
    text-decoration: none;
  }
  nav a.active {
    text-decoration: none;
    border-bottom-color: var(--accent);
  }

  .menu-button {
    display: none;
    background: transparent;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    color: rgb(var(--black));
    transition: opacity 0.2s;
  }
  
  .menu-button:hover {
    opacity: 0.7;
  }
  
  .menu-button:active {
    opacity: 0.5;
  }

  .nav-panel {
    position: fixed;
    top: 0;
    right: -100%;
    height: 100vh;
    width: 340px;
    max-width: 86%;
    background: var(--bg, #fff);
    box-shadow: -8px 0 24px rgba(0,0,0,0.25);
    transition: right 260ms ease;
    z-index: 1200;
    display: flex;
    flex-direction: column;
  }
  .nav-panel.open {
    right: 0;
  }
  .nav-panel-inner {
    padding: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .panel-header {
    display: flex;
    justify-content: flex-end;
  }
  .panel-close {
    background: transparent;
    border: none;
    font-size: 1.6rem;
    line-height: 1;
    cursor: pointer;
    color: var(--muted, #666);
  }
  .panel-links {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    margin-top: 0.5rem;
  }
  .panel-links a {
    display: block;
    padding: 1rem 0.25rem;
    font-size: 1.125rem;
    width: 100%;
    border-bottom: 1px solid rgba(0,0,0,0.06);
  }
  .panel-links a.active {
    font-weight: 700;
  }
  .panel-social {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: auto;
    padding-bottom: 1.5rem;
  }

  /* When nav is collapsed (overflow) hide inline links and show menu */
  nav.collapsed .internal-links {
    display: none;
  }
  nav.collapsed .menu-button {
    display: inline-flex;
  }

  .social-links,
  .social-links a {
    display: flex;
  }

  @media (max-width: 720px) {
    .social-links { display: none; }
    .internal-links { display: none; }
    .menu-button { display: inline-flex; }
  }
</style>

<script>
  (() => {
    const debounce = (fn, wait = 100) => {
      let t;
      return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    };

    function checkOverflow() {
      const nav = document.querySelector('header > nav');
      if (!nav) return;
      const links = nav.querySelector('.internal-links');
      const toggle = document.getElementById('menuToggle');
      if (!links || !toggle) return;
      // if the scroll width exceeds the visible width, we have overflow
      const isOverflowing = links.scrollWidth > links.clientWidth + 2;
      if (isOverflowing) {
        nav.classList.add('collapsed');
        toggle.setAttribute('aria-expanded', 'false');
        document.getElementById('navPanel')?.setAttribute('aria-hidden', 'true');
      } else {
        nav.classList.remove('collapsed');
      }
    }

    function togglePanel(open) {
      const panel = document.getElementById('navPanel');
      const toggle = document.getElementById('menuToggle');
      if (!panel || !toggle) return;
      if (open) {
        panel.classList.add('open');
        panel.setAttribute('aria-hidden', 'false');
        toggle.setAttribute('aria-expanded', 'true');
        // prevent body scroll while menu is open
        try { document.body.style.overflow = 'hidden'; } catch (e) {}
      } else {
        panel.classList.remove('open');
        panel.setAttribute('aria-hidden', 'true');
        toggle.setAttribute('aria-expanded', 'false');
        try { document.body.style.overflow = ''; } catch (e) {}
      }
    }

    window.addEventListener('load', () => {
      checkOverflow();
      const toggle = document.getElementById('menuToggle');
      const panel = document.getElementById('navPanel');
      if (toggle) {
        toggle.addEventListener('click', () => {
          const isOpen = panel?.classList.contains('open');
          togglePanel(!isOpen);
        });
      }
      // close panel when clicking outside
      document.addEventListener('click', (e) => {
        const panelEl = document.getElementById('navPanel');
        const toggleEl = document.getElementById('menuToggle');
        if (!panelEl) return;
        if (!panelEl.classList.contains('open')) return;
        const target = e.target;
        if (!(target instanceof Node)) return;
        if (panelEl.contains(target) || (toggleEl && toggleEl.contains(target))) return;
        togglePanel(false);
      });

      // close button inside panel
      const closeBtn = document.getElementById('panelClose');
      if (closeBtn) closeBtn.addEventListener('click', () => togglePanel(false));
      // close on ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') togglePanel(false);
      });
    });

    // on resize, re-check overflow and close panel if inline nav is visible
    window.addEventListener('resize', debounce(() => {
      checkOverflow();
      const nav = document.querySelector('header > nav');
      if (!nav) return;
      if (!nav.classList.contains('collapsed')) {
        togglePanel(false);
      }
    }, 120));
  })();
</script>
